<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CSV Cleaner</title>
  <link rel="icon" href="favicon.ico">

  <!-- Excel (.xlsx/.xls) support (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --text:#111111;
      --muted:#555555;
      --card:#ffffff;
      --border:#dddddd;
      --input-bg:#ffffff;
      --code-bg:#f6f6f6;
      --btn-bg:#ffffff;
      --btn-border:#aaaaaa;
      --shadow: 0 10px 40px rgba(0,0,0,.06);
      --card-radius:16px;
      --accent:#2f6bff;
      --accent-bg: rgba(47,107,255,.10);

      --logo-bg:#ffffff;
      --logo-border: rgba(0,0,0,.10);
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0f1115;
        --text:#e7e7e7;
        --muted:#b6b6b6;
        --card:#151924;
        --border:#2a3242;
        --input-bg:#0f1115;
        --code-bg:#1c2230;
        --btn-bg:#151924;
        --btn-border:#2a3242;
        --shadow: 0 10px 50px rgba(0,0,0,.35);
        --accent:#7aa2ff;
        --accent-bg: rgba(122,162,255,.12);

        --logo-bg:#ffffff;
        --logo-border: rgba(255,255,255,.14);
      }
    }

    html[data-theme="light"]{
      --bg:#ffffff;
      --text:#111111;
      --muted:#555555;
      --card:#ffffff;
      --border:#dddddd;
      --input-bg:#ffffff;
      --code-bg:#f6f6f6;
      --btn-bg:#ffffff;
      --btn-border:#aaaaaa;
      --shadow: 0 10px 40px rgba(0,0,0,.06);
      --accent:#2f6bff;
      --accent-bg: rgba(47,107,255,.10);
      --logo-bg:#ffffff;
      --logo-border: rgba(0,0,0,.10);
    }

    html[data-theme="dark"]{
      --bg:#0f1115;
      --text:#e7e7e7;
      --muted:#b6b6b6;
      --card:#151924;
      --border:#2a3242;
      --input-bg:#0f1115;
      --code-bg:#1c2230;
      --btn-bg:#151924;
      --btn-border:#2a3242;
      --shadow: 0 10px 50px rgba(0,0,0,.35);
      --accent:#7aa2ff;
      --accent-bg: rgba(122,162,255,.12);
      --logo-bg:#ffffff;
      --logo-border: rgba(255,255,255,.14);
    }

    *{box-sizing:border-box}

    body{
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,Segoe UI,Arial,sans-serif;
      max-width:980px;
      margin:40px auto;
      padding:0 16px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }

    h1{
      margin:0;
      font-size:44px;
      letter-spacing:.2px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--card-radius);
      padding:18px;
      box-shadow:var(--shadow);
    }

    .hidden{ display:none !important; }

    button{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--btn-border);
      background:var(--btn-bg);
      color:var(--text);
      cursor:pointer;
      height:40px;
      white-space:nowrap;
    }

    button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

    .ghost{
      padding:8px 12px;
      font-size:14px;
      height:auto;
    }

    small{color:var(--muted)}
    code{background:var(--code-bg);padding:2px 6px;border-radius:8px}

    .intro{
      display:grid;
      gap:14px;
    }

    .vendorGrid{
      display:grid;
      gap:12px;
      grid-template-columns: 1fr;
    }

    @media (min-width:720px){
      .vendorGrid{ grid-template-columns: 1fr 1fr; }
    }

    .vendorBtn{
      display:flex;
      align-items:center;
      gap:12px;
      height:auto;
      padding:14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--btn-bg);
      text-align:left;
    }

    .vendorLogo{
      width:44px;
      height:44px;
      border-radius:12px;
      background:var(--logo-bg);
      border:1px solid var(--logo-border);
      display:grid;
      place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }

    .vendorLogo img{
      width:100%;
      height:100%;
      object-fit:contain;
      padding:6px;
      display:block;
      background:transparent;
    }

    .vendorLogo .fallback{
      font-size:12px;
      color:var(--muted);
      font-weight:600;
      display:none;
      padding:0 6px;
      text-align:center;
      line-height:1.1;
    }

    .vendorText{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }

    .vendorName{
      font-weight:700;
      line-height:1.1;
      font-size:16px;
    }

    .vendorHint{
      font-size:13px;
      color:var(--muted);
      line-height:1.2;
    }

    .controls{
      display:grid;
      gap:12px;
      align-items:end;
      margin-top:6px;
    }
    .controls > *{ width:100% }

    @media (min-width:860px){
      .controls{
        grid-template-columns: 1.35fr 1fr 1fr auto;
      }
      .controls > *{ width:auto }
      .controls label{ min-width: 210px; }
    }

    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:14px;
      color:var(--text);
      line-height:1.2;
    }

    input[type="file"]{
      padding:8px;
      color:var(--text);
      background:transparent;
    }

    input[type="number"],
    input[type="text"]{
      padding:10px 10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--input-bg);
      color:var(--text);
      height:40px;
    }

    .badgeRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }

    .vendorBadge{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--accent-bg);
    }

    .vendorBadge .miniLogo{
      width:26px;
      height:26px;
      border-radius:8px;
      overflow:hidden;
      border:1px solid var(--logo-border);
      background:var(--logo-bg);
      display:grid;
      place-items:center;
    }

    .vendorBadge .miniLogo img{
      width:100%;
      height:100%;
      object-fit:contain;
      padding:4px;
      display:block;
    }

    .vendorBadge .miniLogo .fallback{
      font-size:11px;
      color:var(--muted);
      font-weight:700;
      display:none;
    }

    .vendorBadge strong{
      font-size:14px;
    }

    .meta{
      margin-top:14px;
      display:grid;
      gap:10px;
      font-size:14px;
    }

    details{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:rgba(0,0,0,0);
    }

    details > summary{
      cursor:pointer;
      font-weight:600;
      list-style:none;
      outline:none;
    }
    details > summary::-webkit-details-marker{ display:none; }

    .legal{
      margin-top:10px;
      display:grid;
      gap:10px;
    }

    .ok{margin-top:14px;font-size:15px}

    .footer{
      margin-top:10px;
      opacity:.7;
      font-size:13px;
    }

    .backBtn{
      height:auto;
      padding:8px 12px;
      font-size:14px;
    }

    /* ISDOC options */
    .isdocBox{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      display:grid;
      gap:10px;
    }
    .isdocGrid{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr;
    }
    @media (min-width:860px){
      .isdocGrid{ grid-template-columns: 1fr 1fr; }
    }
    .checkRow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
    }
    .checkRow input{ margin-top:3px; }
  </style>
</head>

<body>
  <div class="topbar">
    <h1>CSV Cleaner</h1>
    <button id="themeBtn" class="ghost" type="button">Tmavý režim</button>
  </div>

  <!-- ÚVODNÍ OBRAZOVKA -->
  <div id="introCard" class="card">
    <div class="intro">
      <small>
        Vyberte dodavatele. Nástroj je určen pro <b>dodací listy / faktury</b> vybraného dodavatele (LKQ / SAG / Cartec) nebo <b>ISDOC</b>.
      </small>

      <div class="vendorGrid">
        <button id="btnLKQ" class="vendorBtn" type="button" aria-label="LKQ">
          <span class="vendorLogo">
            <img id="logoLKQ" src="logos/lkq.png" alt="LKQ logo" loading="eager">
            <span class="fallback">LKQ</span>
          </span>
          <span class="vendorText">
            <span class="vendorName">LKQ</span>
            <span class="vendorHint">Dodací listy LKQ</span>
          </span>
        </button>

        <button id="btnSAG" class="vendorBtn" type="button" aria-label="SAG">
          <span class="vendorLogo">
            <img id="logoSAG" src="logos/sag.png" alt="SAG logo" loading="eager">
            <span class="fallback">SAG</span>
          </span>
          <span class="vendorText">
            <span class="vendorName">SAG</span>
            <span class="vendorHint">Dodací listy SAG (PŘIPRAVUJE SE)</span>
          </span>
        </button>

        <button id="btnCartec" class="vendorBtn" type="button" aria-label="Cartec">
          <span class="vendorLogo">
            <span class="fallback" style="display:block;">CAR</span>
          </span>
          <span class="vendorText">
            <span class="vendorName">Cartec</span>
            <span class="vendorHint">Dodací listy/Faktury Cartec</span>
          </span>
        </button>

        <!-- ✅ NEW: ISDOC button -->
        <button id="btnISDOC" class="vendorBtn" type="button" aria-label="ISDOC">
          <span class="vendorLogo">
            <span class="fallback" style="display:block;">XML</span>
          </span>
          <span class="vendorText">
            <span class="vendorName">ISDOC</span>
            <span class="vendorHint">Faktury ISDOC (.isdoc) → CSV</span>
          </span>
        </button>
      </div>

      <small>
        Zpracování probíhá <b>přímo v prohlížeči</b>. Data se nikam neodesílají ani neukládají na server.
        Podporované vstupy: <b>.csv, .xlsx/.xls, .isdoc</b>. Výstup je <b>.csv</b>.
      </small>
    </div>
  </div>

  <!-- APLIKACE -->
  <div id="appCard" class="card hidden">
    <div class="badgeRow">
      <div class="vendorBadge" id="vendorBadge">
        <span class="miniLogo">
          <img id="vendorMiniLogo" src="logos/lkq.png" alt="Dodavatel">
          <span class="fallback" id="vendorMiniFallback">LKQ</span>
        </span>
        <strong id="vendorName">LKQ</strong>
      </div>

      <button id="backBtn" class="backBtn" type="button">Změnit dodavatele</button>
    </div>

    <div class="controls">
      <input id="file" type="file"
             accept=".csv,text/csv,.xlsx,.xls,.isdoc,application/xml,text/xml">

      <label>
        Odebrat řádky 1 až
        <input id="head" type="number" value="16" min="0">
      </label>

      <label>
        Odebrat od textu
        <input id="marker" type="text" value="Sazba DPH">
      </label>

      <button id="run" disabled>Promazat a stáhnout</button>
    </div>

    <!-- ✅ ISDOC options -->
    <div id="isdocOptions" class="isdocBox hidden" style="margin-top:12px;">
      <div><b>ISDOC výstup</b> (věrně podle XML tagů)</div>

      <div class="isdocGrid">
        <div class="checkRow">
          <input id="isdocHeadersCz" type="checkbox">
          <div>
            <b>Přeložit hlavičky do češtiny</b><br>
            <small>Jinak zůstane názvosloví v EN (podle tagů).</small>
          </div>
        </div>

        <div class="checkRow">
          <input id="isdocIncludeDocMeta" type="checkbox" checked>
          <div>
            <b>Zahrnout metadatové sloupce dokladu</b><br>
            <small>ID, IssueDate, Currency, Note, Supplier/Customer…</small>
          </div>
        </div>

        <div class="checkRow">
          <input id="isdocIncludePayment" type="checkbox">
          <div>
            <b>Zahrnout PaymentMeans</b><br>
            <small>IBAN, VS, due date… (pokud existuje)</small>
          </div>
        </div>

        <div class="checkRow">
          <input id="isdocNumbersEn" type="checkbox">
          <div>
            <b>EN formát čísel</b><br>
            <small>Tečka jako desetinný oddělovač (jinak čárka).</small>
          </div>
        </div>
      </div>

      <small>
        ISDOC detekce je striktní: musí to být <code>Invoice</code> s ISDOC namespace (např. <code>http://isdoc.cz/namespace/2013</code>).
      </small>
    </div>

    <div class="meta">
      <small>
        Nástroj je určen pro <b>dodací listy / faktury vybraného dodavatele</b>.
      </small>

      <details>
        <summary>Právní informace a odpovědnost</summary>
        <div class="legal">
          <small>
            <b>Odpovědnost:</b> Aplikace je poskytována „tak, jak je“. Autor nenese odpovědnost za případné chyby, ztrátu dat ani škody vzniklé použitím tohoto nástroje.
            Doporučujeme pracovat s kopií původních souborů (záloha).
          </small>
          <small>
            <b>Soukromí:</b> Soubory jsou zpracovány výhradně lokálně na Vašem zařízení. Žádná data nejsou odesílána na server, ukládána ani sdílena s třetí stranou.
          </small>
          <small>
            <b>Vhodné použití:</b> Pro nejlepší stabilitu používejte rozumné velikosti souborů a aktualizovaný prohlížeč. Při extrémních objemech dat může dojít k pomalejší odezvě nebo chybě z důvodu omezení paměti prohlížeče.
          </small>
        </div>
      </details>

      <div id="msg" class="ok"></div>

      <div class="footer">
        CSV Cleaner · verze 1.7 · 2026 · vytvořeno uživateli pro uživatele
      </div>
    </div>
  </div>

<script>
  // ===== THEME =====
  const themeBtn = document.getElementById("themeBtn");

  function getSystemTheme(){
    return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
  }
  function applyTheme(t){
    if(!t){
      document.documentElement.removeAttribute("data-theme");
    }else{
      document.documentElement.setAttribute("data-theme", t);
    }
    themeBtn.textContent = (t || getSystemTheme()) === "dark" ? "Světlý režim" : "Tmavý režim";
  }
  applyTheme(localStorage.getItem("theme"));

  themeBtn.addEventListener("click", () => {
    const current = document.documentElement.getAttribute("data-theme") || getSystemTheme();
    const next = current === "dark" ? "light" : "dark";
    localStorage.setItem("theme", next);
    applyTheme(next);
  });

  // ===== LOGO FALLBACKS =====
  function wireLogoFallback(imgId){
    const img = document.getElementById(imgId);
    if(!img) return;
    img.addEventListener("error", () => {
      const container = img.parentElement;
      const fallback = container ? container.querySelector(".fallback") : null;
      img.style.display = "none";
      if(fallback) fallback.style.display = "block";
    });
  }
  wireLogoFallback("logoLKQ");
  wireLogoFallback("logoSAG");

  // ===== VIEW SWITCH =====
  const introCard = document.getElementById("introCard");
  const appCard = document.getElementById("appCard");
  const backBtn = document.getElementById("backBtn");

  const btnLKQ = document.getElementById("btnLKQ");
  const btnSAG = document.getElementById("btnSAG");
  const btnCartec = document.getElementById("btnCartec");
  const btnISDOC = document.getElementById("btnISDOC"); // ✅

  const vendorNameEl = document.getElementById("vendorName");
  const vendorMiniLogo = document.getElementById("vendorMiniLogo");
  const vendorMiniFallback = document.getElementById("vendorMiniFallback");

  // ISDOC options
  const isdocOptionsBox = document.getElementById("isdocOptions");
  const isdocHeadersCz = document.getElementById("isdocHeadersCz");
  const isdocIncludeDocMeta = document.getElementById("isdocIncludeDocMeta");
  const isdocIncludePayment = document.getElementById("isdocIncludePayment");
  const isdocNumbersEn = document.getElementById("isdocNumbersEn");

  // ===== APP ELEMENTS =====
  const fileEl = document.getElementById("file");
  const runBtn = document.getElementById("run");
  const msg = document.getElementById("msg");
  const headEl = document.getElementById("head");
  const markerEl = document.getElementById("marker");

  // Vendor presets
  const VENDORS = {
    LKQ: {
      head: 16,
      marker: "Sazba DPH",
      logo: "logos/lkq.png",
      excel_mode: "simple"
    },
    SAG: {
      head: 16,
      marker: "Sazba DPH",
      logo: "logos/sag.png",
      excel_mode: "simple"
    },
    CARTEC: {
      head: 50,
      marker: "Celkem zboží|Celkem CZK|Rekapitulace DPH|Total|VAT",
      logo: "",
      excel_mode: "cartec_map"
    },
    ISDOC: {
      head: 0,
      marker: "",
      logo: "",
      excel_mode: "isdoc"
    }
  };

  let ACTIVE_VENDOR = "LKQ";

  function setVendor(v){
    ACTIVE_VENDOR = v;
    const cfg = VENDORS[v];

    vendorNameEl.textContent = v;
    vendorMiniFallback.textContent = v;

    // logo behavior
    if(cfg.logo){
      vendorMiniLogo.style.display = "block";
      vendorMiniLogo.src = cfg.logo;
      vendorMiniLogo.onerror = () => {
        vendorMiniLogo.style.display = "none";
        vendorMiniFallback.style.display = "block";
      };
      vendorMiniFallback.style.display = "none";
    } else {
      vendorMiniLogo.style.display = "none";
      vendorMiniFallback.style.display = "block";
    }

    headEl.value = String(cfg.head);
    markerEl.value = cfg.marker;

    // Show ISDOC options only when vendor = ISDOC
    if(v === "ISDOC"){
      isdocOptionsBox.classList.remove("hidden");
    } else {
      isdocOptionsBox.classList.add("hidden");
    }

    fileEl.value = "";
    runBtn.disabled = true;
    msg.textContent = "";
  }

  function showApp(){
    introCard.classList.add("hidden");
    appCard.classList.remove("hidden");
  }

  function showIntro(){
    appCard.classList.add("hidden");
    introCard.classList.remove("hidden");
    msg.textContent = "";
    fileEl.value = "";
    runBtn.disabled = true;
    isdocOptionsBox.classList.add("hidden");
  }

  btnLKQ.addEventListener("click", () => { setVendor("LKQ"); showApp(); });
  btnSAG.addEventListener("click", () => { setVendor("SAG"); showApp(); });
  btnCartec.addEventListener("click", () => { setVendor("CARTEC"); showApp(); });
  btnISDOC.addEventListener("click", () => { setVendor("ISDOC"); showApp(); }); // ✅
  backBtn.addEventListener("click", () => { showIntro(); });

  // ===== FILE HANDLING (1 file only) =====
  fileEl.addEventListener("change", () => {
    runBtn.disabled = !(fileEl.files && fileEl.files.length === 1);
    msg.textContent = "";
  });

  function normalizeLines(text){
    return text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n");
  }

  function extOf(name){
    const i = name.lastIndexOf(".");
    return i === -1 ? "" : name.slice(i+1).toLowerCase();
  }

  // ===== CSV helpers (Excel friendly) =====
  function csvEscape(cell, sep){
    let s = (cell ?? "").toString();
    s = s.replace(/\r?\n/g, " ");
    const mustQuote = s.includes(sep) || s.includes('"');
    if(mustQuote){
      s = '"' + s.replace(/"/g, '""') + '"';
    }
    return s;
  }

  function toDelimitedRow(arr, sep){
    return arr.map(v => csvEscape(v, sep)).join(sep);
  }

  // ✅ UTF-8 + BOM
  function downloadCsvUtf8Bom(text, filename){
    const BOM = "\uFEFF";
    const blob = new Blob([BOM + text], { type:"text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  function cleanCellString(v){
    let s = (v ?? "").toString();
    s = s.replace(/\$/g, "");
    s = s.replace(/\u00A0/g, " ");
    s = s.replace(/[ \t]+/g, " ").trim();
    return s;
  }

  function isRowEmpty(arr){
    for(const v of arr){
      if(cleanCellString(v) !== "") return false;
    }
    return true;
  }

  // ===== Cartec Excel mapping (as in your version) =====
  function stripDiacritics(s){
    return (s || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }
  function normKey(s){
    const t = stripDiacritics((s || "").toLowerCase());
    return t
      .replace(/\./g, " ")
      .replace(/[%]/g, " percent ")
      .replace(/[^a-z0-9]+/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  const CARTEC_FIELDS = [
    { key:"number",    label:"Číslo"     },
    { key:"desc",      label:"Popis"     },
    { key:"qty",       label:"Množ."     },
    { key:"mj",        label:"MJ"        },
    { key:"unitprice", label:"Jedn. cena"},
    { key:"discount",  label:"% slevy"   },
    { key:"vat",       label:"DPH %"     },
    { key:"amount",    label:"Částka"    },
  ];

  const CARTEC_SYNONYMS = {
    number:    ["cislo","item number","item no","number","code","part number","part no","article","artikl","produkt","product code"],
    desc:      ["popis","nazev","polozka","item","description","desc","product","goods","name"],
    qty:       ["mnoz","mnozstvi","qty","quantity","count","pcs","pieces"],
    mj:        ["mj","merna jednotka","unit","uom","unit of measure","measure unit"],
    unitprice: ["jedn cena","jednotkova cena","unit price","unitprice","price per unit","price"],
    discount:  ["sleva","slevy","slev","% sleva","% slevy","discount","disc","rebate","% discount"],
    vat:       ["dph","dph percent","vat","vat percent","tax","tax percent","vat rate"],
    amount:    ["castka","celkem","total","line total","amount","sum","line amount","price total"]
  };

  const CARTEC_STOP_MARKERS = [
    "celkem zbozi", "celkem czk", "rekapitulace dph",
    "total goods", "vat summary", "tax summary",
    "total", "grand total"
  ];

  function findCartecHeaderMapping(rows){
    const required = ["number","desc","amount"];

    for(let r=0; r<rows.length; r++){
      const row = rows[r] || [];
      if(isRowEmpty(row)) continue;

      const map = {};
      for(let c=0; c<row.length; c++){
        const cell = cleanCellString(row[c]);
        if(!cell) continue;

        const nk = normKey(cell);

        for(const field of CARTEC_FIELDS){
          const syns = CARTEC_SYNONYMS[field.key] || [];
          if(syns.some(s => nk.includes(normKey(s)))){
            if(map[field.key] === undefined) map[field.key] = c;
          }
        }
      }

      const hasRequired = required.every(k => map[k] !== undefined);
      const countFound = Object.keys(map).length;

      if(hasRequired && countFound >= 5){
        return { headerRow: r, colMap: map };
      }
    }
    return null;
  }

  function rowHasStopMarker(rowSlice){
    const joined = rowSlice.map(cleanCellString).join(" ").toLowerCase();
    const nk = normKey(joined);
    return CARTEC_STOP_MARKERS.some(m => nk.includes(normKey(m)));
  }

  async function readExcelRows(file){
    if(!window.XLSX) throw new Error("Chybí XLSX knihovna (SheetJS).");
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type:"array" });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, {
      header: 1,
      raw: false,
      defval: "",
      blankrows: false
    });
    return rows;
  }

  function rowsToSimpleCsv(rows){
    const out = rows
      .filter(r => !isRowEmpty(r || []))
      .map(r => toDelimitedRow((r || []).map(cleanCellString), ";"))
      .join("\n") + "\n";
    return out;
  }

  function rowsToCartecMappedCsv(rows){
    const found = findCartecHeaderMapping(rows);
    if(!found){
      throw new Error("Cartec: Nepodařilo se najít hlavičku tabulky (Číslo/Popis/Částka…). Dodavatel pravděpodobně změnil šablonu.");
    }

    const { headerRow, colMap } = found;

    const out = [];
    out.push(toDelimitedRow(CARTEC_FIELDS.map(f => f.label), ";"));

    for(let r = headerRow + 1; r < rows.length; r++){
      const row = rows[r] || [];

      const picked = CARTEC_FIELDS.map(f => {
        const idx = colMap[f.key];
        return idx === undefined ? "" : cleanCellString(row[idx]);
      });

      if(isRowEmpty(picked)) continue;
      if(rowHasStopMarker(picked)) break;

      out.push(toDelimitedRow(picked, ";"));
    }

    if(out.length <= 1){
      throw new Error("Cartec: Tabulka byla nalezena, ale nebyly detekovány žádné položky.");
    }

    return out.join("\n") + "\n";
  }

  // ===== CSV cleaning =====
  function parseMarkerList(markerText){
    return (markerText || "")
      .split("|")
      .map(s => s.trim())
      .filter(Boolean);
  }

  function cleanCsvText(text, removeTopN, markerText){
    let lines = normalizeLines(text);
    lines = lines.slice(Math.max(0, removeTopN));

    const markers = parseMarkerList(markerText);
    if(markers.length){
      const cutAt = lines.findIndex(l => {
        const t = (l ?? "").trim();
        return markers.some(m => t.includes(m));
      });
      if(cutAt !== -1) lines = lines.slice(0, cutAt);
    }

    while(lines.length && lines[lines.length-1].trim()==="") lines.pop();
    return lines.join("\n") + "\n";
  }

  // ===== ISDOC strict parser (same as earlier) =====
  function isIsdocDocument(xmlDoc){
    const root = xmlDoc.documentElement;
    if(!root) return false;
    const local = root.localName || root.nodeName;
    const ns = root.namespaceURI || "";
    if(local !== "Invoice") return false;
    return ns.includes("isdoc.cz/namespace");
  }

  function firstElNS(parent, localName){
    if(!parent) return null;
    return parent.getElementsByTagNameNS("*", localName)[0] || null;
  }

  function firstTextNS(parent, localName){
    const el = firstElNS(parent, localName);
    return el ? (el.textContent || "").trim() : "";
  }

  function attrOrEmpty(el, attrName){
    if(!el) return "";
    return (el.getAttribute(attrName) || "").trim();
  }

  function numToLocale(n, useEn){
    if(n === "" || n === null || typeof n === "undefined") return "";
    const s = String(n).trim();
    const x = Number(s.replace(",", "."));
    if(!Number.isFinite(x)) return s;
    const hasDecimals = Math.abs(x % 1) > 0;
    const out = hasDecimals ? x.toFixed(2) : String(x);
    return useEn ? out : out.replace(".", ",");
  }

  const ISDOC_HEADERS_EN = [
    "DocumentType",
    "ID",
    "UUID",
    "IssuingSystem",
    "IssueDate",
    "TaxPointDate",
    "VATApplicable",
    "Note",
    "LocalCurrencyCode",
    "AccountingSupplierParty_Name",
    "AccountingSupplierParty_ID",
    "AccountingCustomerParty_Name",
    "AccountingCustomerParty_ID",

    "InvoiceLine_ID",
    "InvoicedQuantity",
    "InvoicedQuantity_unitCode",
    "LineExtensionAmount",
    "LineExtensionAmountTaxInclusive",
    "LineExtensionTaxAmount",
    "UnitPrice",
    "UnitPriceTaxInclusive",
    "ClassifiedTaxCategory_Percent",
    "InvoiceLine_Note",
    "Item_Description",
    "CatalogueItemIdentification_ID",
    "SellersItemIdentification_ID"
  ];

  const ISDOC_HEADERS_CZ = {
    DocumentType: "Typ dokladu",
    ID: "Číslo dokladu",
    UUID: "UUID",
    IssuingSystem: "Vystavovací systém",
    IssueDate: "Datum vystavení",
    TaxPointDate: "Datum zdanitelného plnění",
    VATApplicable: "DPH použitelné",
    Note: "Poznámka",
    LocalCurrencyCode: "Měna",

    AccountingSupplierParty_Name: "Dodavatel – název",
    AccountingSupplierParty_ID: "Dodavatel – IČ",
    AccountingCustomerParty_Name: "Odběratel – název",
    AccountingCustomerParty_ID: "Odběratel – IČ",

    InvoiceLine_ID: "Položka – ID",
    InvoicedQuantity: "Množství",
    InvoicedQuantity_unitCode: "MJ",
    LineExtensionAmount: "Základ (bez DPH)",
    LineExtensionAmountTaxInclusive: "Celkem (s DPH)",
    LineExtensionTaxAmount: "DPH částka",
    UnitPrice: "Jedn. cena (bez DPH)",
    UnitPriceTaxInclusive: "Jedn. cena (s DPH)",
    ClassifiedTaxCategory_Percent: "DPH %",
    InvoiceLine_Note: "Položka – poznámka",
    Item_Description: "Položka – popis",
    CatalogueItemIdentification_ID: "EAN",
    SellersItemIdentification_ID: "Kód dodavatele"
  };

  function buildIsdocHeaderRow(useCz, includeDocMeta, includePayment){
    let base = [...ISDOC_HEADERS_EN];

    if(!includeDocMeta){
      const drop = new Set([
        "DocumentType","ID","UUID","IssuingSystem","IssueDate","TaxPointDate","VATApplicable","Note","LocalCurrencyCode",
        "AccountingSupplierParty_Name","AccountingSupplierParty_ID",
        "AccountingCustomerParty_Name","AccountingCustomerParty_ID"
      ]);
      base = base.filter(x => !drop.has(x));
    }

    if(includePayment){
      base.push(
        "PaymentDueDate","Payment_ID","BankCode","BankName","IBAN","BIC","VariableSymbol","ConstantSymbol"
      );
      ISDOC_HEADERS_CZ.PaymentDueDate = "Splatnost";
      ISDOC_HEADERS_CZ.Payment_ID = "Číslo účtu / ID platby";
      ISDOC_HEADERS_CZ.BankCode = "Kód banky";
      ISDOC_HEADERS_CZ.BankName = "Banka";
      ISDOC_HEADERS_CZ.IBAN = "IBAN";
      ISDOC_HEADERS_CZ.BIC = "BIC";
      ISDOC_HEADERS_CZ.VariableSymbol = "Variabilní symbol";
      ISDOC_HEADERS_CZ.ConstantSymbol = "Konstantní symbol";
    }

    return {
      keys: base,
      labels: base.map(h => useCz ? (ISDOC_HEADERS_CZ[h] || h) : h)
    };
  }

  function parseIsdocToCsvText(xmlText, opts){
    const xmlDoc = new DOMParser().parseFromString(xmlText, "application/xml");
    if(xmlDoc.getElementsByTagName("parsererror").length){
      throw new Error("Soubor není validní XML.");
    }
    if(!isIsdocDocument(xmlDoc)){
      throw new Error("Soubor není ISDOC. Očekávám root <Invoice> s ISDOC namespace.");
    }

    const inv = xmlDoc.documentElement;

    const docType = firstTextNS(inv, "DocumentType");
    const id = firstTextNS(inv, "ID");
    const uuid = firstTextNS(inv, "UUID");
    const issuingSystem = firstTextNS(inv, "IssuingSystem");
    const issueDate = firstTextNS(inv, "IssueDate");
    const taxPointDate = firstTextNS(inv, "TaxPointDate");
    const vatApplicable = firstTextNS(inv, "VATApplicable");
    const note = firstTextNS(inv, "Note");
    const currency = firstTextNS(inv, "LocalCurrencyCode");

    let supplierName = "", supplierId = "", customerName = "", customerId = "";
    const asp = firstElNS(inv, "AccountingSupplierParty");
    if(asp){
      const party = firstElNS(asp, "Party");
      if(party){
        const pid = firstElNS(party, "PartyIdentification");
        if(pid) supplierId = firstTextNS(pid, "ID");
        const pn = firstElNS(party, "PartyName");
        if(pn) supplierName = firstTextNS(pn, "Name");
      }
    }
    const acp = firstElNS(inv, "AccountingCustomerParty");
    if(acp){
      const party = firstElNS(acp, "Party");
      if(party){
        const pid = firstElNS(party, "PartyIdentification");
        if(pid) customerId = firstTextNS(pid, "ID");
        const pn = firstElNS(party, "PartyName");
        if(pn) customerName = firstTextNS(pn, "Name");
      }
    }

    let payDueDate="", payId="", bankCode="", bankName="", iban="", bic="", vs="", ks="";
    if(opts.includePayment){
      const pm = firstElNS(inv, "PaymentMeans");
      if(pm){
        const payment = firstElNS(pm, "Payment");
        if(payment){
          const details = firstElNS(payment, "Details");
          if(details){
            payDueDate = firstTextNS(details, "PaymentDueDate");
            payId = firstTextNS(details, "ID");
            bankCode = firstTextNS(details, "BankCode");
            bankName = firstTextNS(details, "Name");
            iban = firstTextNS(details, "IBAN");
            bic = firstTextNS(details, "BIC");
            vs = firstTextNS(details, "VariableSymbol");
            ks = firstTextNS(details, "ConstantSymbol");
          }
        }
      }
    }

    const hdr = buildIsdocHeaderRow(opts.headersCz, opts.includeDocMeta, opts.includePayment);
    const outRows = [];
    outRows.push(toDelimitedRow(hdr.labels, ";"));

    const linesContainer = firstElNS(inv, "InvoiceLines");
    const lineEls = linesContainer ? Array.from(linesContainer.getElementsByTagNameNS("*", "InvoiceLine")) : [];

    if(!lineEls.length){
      throw new Error("ISDOC: nenalezeny žádné InvoiceLine položky.");
    }

    for(const il of lineEls){
      const qtyEl = firstElNS(il, "InvoicedQuantity");
      const qty = qtyEl ? (qtyEl.textContent || "").trim() : "";
      const unitCode = qtyEl ? attrOrEmpty(qtyEl, "unitCode") : "";

      let vatPct = "";
      const ctc = firstElNS(il, "ClassifiedTaxCategory");
      if(ctc) vatPct = firstTextNS(ctc, "Percent");

      let itemDesc="", ean="", sellerCode="";
      const item = firstElNS(il, "Item");
      if(item){
        itemDesc = firstTextNS(item, "Description");
        const cat = firstElNS(item, "CatalogueItemIdentification");
        if(cat) ean = firstTextNS(cat, "ID");
        const sel = firstElNS(item, "SellersItemIdentification");
        if(sel) sellerCode = firstTextNS(sel, "ID");
      }

      const rec = {
        DocumentType: docType,
        ID: id,
        UUID: uuid,
        IssuingSystem: issuingSystem,
        IssueDate: issueDate,
        TaxPointDate: taxPointDate,
        VATApplicable: vatApplicable,
        Note: note,
        LocalCurrencyCode: currency,
        AccountingSupplierParty_Name: supplierName,
        AccountingSupplierParty_ID: supplierId,
        AccountingCustomerParty_Name: customerName,
        AccountingCustomerParty_ID: customerId,

        InvoiceLine_ID: firstTextNS(il, "ID"),
        InvoicedQuantity: qty,
        InvoicedQuantity_unitCode: unitCode,
        LineExtensionAmount: firstTextNS(il, "LineExtensionAmount"),
        LineExtensionAmountTaxInclusive: firstTextNS(il, "LineExtensionAmountTaxInclusive"),
        LineExtensionTaxAmount: firstTextNS(il, "LineExtensionTaxAmount"),
        UnitPrice: firstTextNS(il, "UnitPrice"),
        UnitPriceTaxInclusive: firstTextNS(il, "UnitPriceTaxInclusive"),
        ClassifiedTaxCategory_Percent: vatPct,
        InvoiceLine_Note: firstTextNS(il, "Note"),
        Item_Description: itemDesc,
        CatalogueItemIdentification_ID: ean,
        SellersItemIdentification_ID: sellerCode,

        PaymentDueDate: payDueDate,
        Payment_ID: payId,
        BankCode: bankCode,
        BankName: bankName,
        IBAN: iban,
        BIC: bic,
        VariableSymbol: vs,
        ConstantSymbol: ks
      };

      const numericKeys = new Set([
        "InvoicedQuantity","LineExtensionAmount","LineExtensionAmountTaxInclusive","LineExtensionTaxAmount",
        "UnitPrice","UnitPriceTaxInclusive","ClassifiedTaxCategory_Percent"
      ]);

      const row = hdr.keys.map(k => {
        const v = rec[k] ?? "";
        if(numericKeys.has(k)) return numToLocale(v, opts.numbersEn);
        return cleanCellString(v);
      });

      outRows.push(toDelimitedRow(row, ";"));
    }

    return outRows.join("\n") + "\n";
  }

  // ===== INPUT ROUTER =====
  async function readInputFileAsText(file){
    const ext = extOf(file.name);
    const cfg = VENDORS[ACTIVE_VENDOR];

    if(ext === "csv") return await file.text();

    if(ext === "xlsx" || ext === "xls"){
      const rows = await readExcelRows(file);
      if(cfg?.excel_mode === "cartec_map"){
        return rowsToCartecMappedCsv(rows);
      }
      return rowsToSimpleCsv(rows);
    }

    if(ext === "isdoc" || ext === "xml"){
      const xmlText = await file.text();
      return parseIsdocToCsvText(xmlText, {
        headersCz: isdocHeadersCz.checked,
        includeDocMeta: isdocIncludeDocMeta.checked,
        includePayment: isdocIncludePayment.checked,
        numbersEn: isdocNumbersEn.checked
      });
    }

    throw new Error("Nepodporovaný typ souboru: " + ext);
  }

  runBtn.addEventListener("click", async () => {
    const file = (fileEl.files && fileEl.files[0]) ? fileEl.files[0] : null;
    if(!file) return;

    const headN = Math.max(0, parseInt(headEl.value || "0", 10));
    const marker = (markerEl.value || "").trim();

    let text;
    try{
      text = await readInputFileAsText(file);
    }catch(e){
      msg.textContent = "Chyba: " + (e?.message || e);
      return;
    }

    const ext = extOf(file.name);

    let cleaned;
    if(ext === "csv"){
      cleaned = cleanCsvText(text, headN, marker);
    } else {
      cleaned = text;
    }

    const outName = (ext === "csv")
      ? file.name
      : file.name.replace(/\.[^.]+$/, "") + ".csv";

    downloadCsvUtf8Bom(cleaned, outName);
    msg.innerHTML = `Hotovo: <code>${outName}</code>`;
  });
</script>
</body>
</html>
