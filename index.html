<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CSV Cleaner</title>
  <link rel="icon" href="favicon.ico">

  <style>
    :root{
      --bg:#ffffff;
      --text:#111111;
      --muted:#555555;
      --card:#ffffff;
      --border:#dddddd;
      --input-bg:#ffffff;
      --code-bg:#f6f6f6;
      --btn-bg:#ffffff;
      --btn-border:#aaaaaa;
      --shadow: 0 10px 40px rgba(0,0,0,.06);
      --card-radius:16px;

      --chip-bg:#f5f6f8;
      --chip-border:#d9dde5;
      --chip-active-bg:#e9eefc;
      --chip-active-border:#9fb4ff;

      --warn-bg:#fff7e6;
      --warn-border:#f1d39b;
      --warn-text:#7a4a00;
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0f1115;
        --text:#e7e7e7;
        --muted:#b6b6b6;
        --card:#151924;
        --border:#2a3242;
        --input-bg:#0f1115;
        --code-bg:#1c2230;
        --btn-bg:#151924;
        --btn-border:#2a3242;
        --shadow: 0 10px 50px rgba(0,0,0,.35);

        --chip-bg:#141a26;
        --chip-border:#2a3242;
        --chip-active-bg:#1a2440;
        --chip-active-border:#5f7cff;

        --warn-bg:#2a210f;
        --warn-border:#5a4724;
        --warn-text:#ffd38a;
      }
    }

    html[data-theme="light"]{
      --bg:#ffffff;
      --text:#111111;
      --muted:#555555;
      --card:#ffffff;
      --border:#dddddd;
      --input-bg:#ffffff;
      --code-bg:#f6f6f6;
      --btn-bg:#ffffff;
      --btn-border:#aaaaaa;
      --shadow: 0 10px 40px rgba(0,0,0,.06);

      --chip-bg:#f5f6f8;
      --chip-border:#d9dde5;
      --chip-active-bg:#e9eefc;
      --chip-active-border:#9fb4ff;

      --warn-bg:#fff7e6;
      --warn-border:#f1d39b;
      --warn-text:#7a4a00;
    }

    html[data-theme="dark"]{
      --bg:#0f1115;
      --text:#e7e7e7;
      --muted:#b6b6b6;
      --card:#151924;
      --border:#2a3242;
      --input-bg:#0f1115;
      --code-bg:#1c2230;
      --btn-bg:#151924;
      --btn-border:#2a3242;
      --shadow: 0 10px 50px rgba(0,0,0,.35);

      --chip-bg:#141a26;
      --chip-border:#2a3242;
      --chip-active-bg:#1a2440;
      --chip-active-border:#5f7cff;

      --warn-bg:#2a210f;
      --warn-border:#5a4724;
      --warn-text:#ffd38a;
    }

    *{box-sizing:border-box}

    body{
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,Segoe UI,Arial,sans-serif;
      max-width:980px;
      margin:40px auto;
      padding:0 16px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }

    h1{
      margin:0;
      font-size:44px;
      letter-spacing:.2px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--card-radius);
      padding:18px;
      box-shadow:var(--shadow);
    }

    .vendorbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:14px;
    }

    .vendorBtn{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--chip-border);
      background:var(--chip-bg);
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }

    .vendorBtn[aria-pressed="true"]{
      background:var(--chip-active-bg);
      border-color:var(--chip-active-border);
    }

    .vendorLogo{
      width:44px;
      height:28px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--card);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }

    .vendorLogo img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      padding:4px;
    }

    .vendorText{
      display:flex;
      flex-direction:column;
      line-height:1.1;
    }
    .vendorText b{font-size:14px}
    .vendorText small{font-size:12px;color:var(--muted)}

    .controls{
      display:grid;
      gap:12px;
      align-items:end;
    }
    .controls > *{ width:100% }

    @media (min-width:860px){
      .controls{
        grid-template-columns: 1.35fr 1fr 1fr auto;
      }
      .controls > *{ width:auto }
    }

    @media (min-width:860px){
      .controls label{ min-width: 210px; }
    }

    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:14px;
      color:var(--text);
      line-height:1.2;
    }

    input[type="file"]{
      padding:8px;
      color:var(--text);
      background:transparent;
    }

    input[type="number"],
    input[type="text"]{
      padding:10px 10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--input-bg);
      color:var(--text);
      height:40px;
    }

    button{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--btn-border);
      background:var(--btn-bg);
      color:var(--text);
      cursor:pointer;
      height:40px;
      white-space:nowrap;
    }

    button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

    .ghost{
      padding:8px 12px;
      font-size:14px;
      height:auto;
    }

    small{color:var(--muted)}
    code{background:var(--code-bg);padding:2px 6px;border-radius:8px}

    .meta{
      margin-top:14px;
      display:grid;
      gap:10px;
      font-size:14px;
    }

    details{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:rgba(0,0,0,0);
    }

    details > summary{
      cursor:pointer;
      font-weight:600;
      list-style:none;
      outline:none;
    }
    details > summary::-webkit-details-marker{ display:none; }

    .legal{
      margin-top:10px;
      display:grid;
      gap:10px;
    }

    .note{
      border:1px solid var(--warn-border);
      background:var(--warn-bg);
      color:var(--warn-text);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      line-height:1.35;
      display:none;
    }

    .ok{margin-top:14px;font-size:15px}
  </style>
</head>

<body>
  <div class="topbar">
    <h1>CSV Cleaner</h1>
    <button id="themeBtn" class="ghost" type="button">Tmavý režim</button>
  </div>

  <div class="card">

    <!-- DODAVATEL -->
    <div class="vendorbar" aria-label="Výběr dodavatele">
      <button class="vendorBtn" id="vendorLKQ" type="button" aria-pressed="true">
        <span class="vendorLogo">
          <img src="assets/AKLogo.png" alt="LKQ">
        </span>
        <span class="vendorText">
          <b>LKQ</b>
          <small>Dodací listy LKQ</small>
        </span>
      </button>

      <button class="vendorBtn" id="vendorSAG" type="button" aria-pressed="false">
        <span class="vendorLogo">
          <img src="assets/SAG_logo_ctverec-1.png" alt="SAG">
        </span>
        <span class="vendorText">
          <b>SAG</b>
          <small>Dodací listy SAG</small>
        </span>
      </button>
    </div>

    <div id="vendorNote" class="note"></div>

    <!-- OVLÁDÁNÍ -->
    <div class="controls">
      <!-- max 1 soubor -->
      <input id="file" type="file" accept=".csv,text/csv">

      <label>
        Odebrat řádky 1 až
        <input id="head" type="number" value="16" min="0">
      </label>

      <label>
        Odebrat od textu
        <input id="marker" type="text" value="Sazba DPH">
      </label>

      <button id="run" disabled>Promazat a stáhnout</button>
    </div>

    <div class="meta">
      <small>
        Nástroj je určen pro <b>dodací listy vybraného dodavatele</b> (LKQ / SAG). Zpracování probíhá <b>přímo v prohlížeči</b>.
        Data se nikam neodesílají ani neukládají na server.
      </small>

      <details>
        <summary>Právní informace a odpovědnost</summary>
        <div class="legal">
          <small>
            <b>Odpovědnost:</b> Aplikace je poskytována „tak, jak je“. Autor nenese odpovědnost za případné chyby, ztrátu dat ani škody vzniklé použitím tohoto nástroje.
            Doporučujeme pracovat s kopií původního souboru (záloha).
          </small>
          <small>
            <b>Soukromí:</b> Soubor je zpracován výhradně lokálně na Vašem zařízení. Žádná data nejsou odesílána na server, ukládána ani sdílena s třetí stranou.
          </small>
          <small>
            <b>Vhodné použití:</b> Pro nejlepší stabilitu používejte rozumné velikosti souborů a aktualizovaný prohlížeč. Při extrémních objemech dat může dojít k pomalejší odezvě nebo chybě z důvodu omezení paměti prohlížeče.
          </small>
        </div>
      </details>

      <div id="msg" class="ok"></div>

      <small style="opacity:.7">
        CSV Cleaner · verze 1.1 · 2025 · vytvořeno uživateli pro uživatele
      </small>
    </div>
  </div>

<script>
  const fileEl = document.getElementById("file");
  const runBtn = document.getElementById("run");
  const msg = document.getElementById("msg");
  const themeBtn = document.getElementById("themeBtn");

  const vendorLKQ = document.getElementById("vendorLKQ");
  const vendorSAG = document.getElementById("vendorSAG");
  const vendorNote = document.getElementById("vendorNote");

  // LKQ je hotové, SAG zatím placeholder
  const VENDORS = {
    LKQ: { enabled: true,  headN: 16, marker: "Sazba DPH" },
    SAG: { enabled: false, headN: 0,  marker: "" }
  };

  let currentVendor = "LKQ";

  function getSystemTheme(){
    return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
  }

  function applyTheme(t){
    if(!t){
      document.documentElement.removeAttribute("data-theme");
    }else{
      document.documentElement.setAttribute("data-theme", t);
    }
    themeBtn.textContent = (t || getSystemTheme()) === "dark" ? "Světlý režim" : "Tmavý režim";
  }
  applyTheme(localStorage.getItem("theme"));

  themeBtn.addEventListener("click", () => {
    const current = document.documentElement.getAttribute("data-theme") || getSystemTheme();
    const next = current === "dark" ? "light" : "dark";
    localStorage.setItem("theme", next);
    applyTheme(next);
  });

  function updateRunState(){
    const hasFile = !!(fileEl.files && fileEl.files.length);
    const vendorEnabled = !!VENDORS[currentVendor].enabled;
    runBtn.disabled = !(hasFile && vendorEnabled);
  }

  function setVendor(v){
    currentVendor = v;

    vendorLKQ.setAttribute("aria-pressed", v === "LKQ" ? "true" : "false");
    vendorSAG.setAttribute("aria-pressed", v === "SAG" ? "true" : "false");

    // nastav předvolby (u SAG zatím neutrální)
    document.getElementById("head").value = VENDORS[v].headN;
    document.getElementById("marker").value = VENDORS[v].marker;

    // info/varování
    if (!VENDORS[v].enabled) {
      vendorNote.style.display = "block";
      vendorNote.textContent = "SAG: nastavení zatím není připravené. Zatím používejte LKQ.";
    } else {
      vendorNote.style.display = "none";
      vendorNote.textContent = "";
    }

    msg.textContent = "";
    updateRunState();
  }

  vendorLKQ.addEventListener("click", () => setVendor("LKQ"));
  vendorSAG.addEventListener("click", () => setVendor("SAG"));

  fileEl.addEventListener("change", () => {
    msg.textContent = "";
    updateRunState();
  });

  function normalizeLines(text){
    return text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n");
  }

  function cleanOneCsv(text, removeTopN, markerText){
    let lines = normalizeLines(text);
    lines = lines.slice(Math.max(0, removeTopN));

    if(markerText){
      const cutAt = lines.findIndex(l => l.includes(markerText));
      if(cutAt !== -1) lines = lines.slice(0, cutAt);
    }

    while(lines.length && lines[lines.length-1].trim()==="") lines.pop();
    return lines;
  }

  runBtn.addEventListener("click", async () => {
    const file = fileEl.files && fileEl.files[0];
    if(!file) return;

    if(!VENDORS[currentVendor].enabled){
      msg.textContent = "Zvolený dodavatel zatím není nastaven.";
      return;
    }

    const headN = Math.max(0, parseInt(document.getElementById("head").value || "0", 10));
    const marker = (document.getElementById("marker").value || "").trim();

    const text = await file.text();
    const lines = cleanOneCsv(text, headN, marker);
    const result = lines.join("\n") + "\n";

    const blob = new Blob([result], { type:"text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);

    // výstupní název = vstupní název (bez _clean)
    a.download = file.name;

    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);

    msg.innerHTML = `Hotovo: <code>${a.download}</code> · dodavatel: <code>${currentVendor}</code>`;
  });

  // start
  setVendor("LKQ");
</script>
</body>
</html>
